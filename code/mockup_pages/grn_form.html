<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhập kho - DEMAX Inventory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-warehouse me-2"></i>DEMAX Inventory
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-1"></i>Admin User
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="login.html">Đăng xuất</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="items.html">
                                <i class="fas fa-box me-2"></i>Vật tư
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="warehouses.html">
                                <i class="fas fa-warehouse me-2"></i>Kho
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="grn_form.html">
                                <i class="fas fa-arrow-down me-2"></i>Nhập kho
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Phiếu nhập kho</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-save me-1"></i>Lưu nháp
                        </button>
                        <button type="button" class="btn btn-outline-secondary">
                            <i class="fas fa-print me-1"></i>In phiếu
                        </button>
                    </div>
                </div>

                <div class="alert-container"></div>

                <!-- Wizard Steps -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar" role="progressbar" style="width: 33%;" id="wizardProgress"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <div class="text-center">
                                <div class="badge bg-primary rounded-circle p-2 mb-1">1</div>
                                <div class="small">Thông tin phiếu</div>
                            </div>
                            <div class="text-center">
                                <div class="badge bg-secondary rounded-circle p-2 mb-1">2</div>
                                <div class="small">Dòng vật tư</div>
                            </div>
                            <div class="text-center">
                                <div class="badge bg-secondary rounded-circle p-2 mb-1">3</div>
                                <div class="small">Xác nhận</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Basic Information -->
                <div class="card" id="step1">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Bước 1: Thông tin phiếu nhập
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="grnNumber" class="form-label required">Số phiếu nhập</label>
                                    <input type="text" class="form-control" id="grnNumber" value="GRN-2024-001" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="grnDate" class="form-label required">Ngày nhập</label>
                                    <input type="date" class="form-control" id="grnDate" required>
                                </div>
                                <div class="mb-3">
                                    <label for="grnWarehouse" class="form-label required">Kho nhập</label>
                                    <select class="form-select" id="grnWarehouse" required>
                                        <option value="">Chọn kho</option>
                                        <option value="WH001" selected>Kho nguyên liệu chính</option>
                                        <option value="WH002">Kho thành phẩm</option>
                                        <option value="WH003">Kho bán thành phẩm</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="grnSupplier" class="form-label">Nhà cung cấp</label>
                                    <select class="form-select" id="grnSupplier">
                                        <option value="">Chọn nhà cung cấp</option>
                                        <option value="SUP001">Công ty TNHH ABC</option>
                                        <option value="SUP002">Công ty CP XYZ</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="grnReference" class="form-label">Số chứng từ gốc</label>
                                    <input type="text" class="form-control" id="grnReference" placeholder="Hóa đơn, phiếu giao hàng...">
                                </div>
                                <div class="mb-3">
                                    <label for="grnNotes" class="form-label">Ghi chú</label>
                                    <textarea class="form-control" id="grnNotes" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Tiếp theo <i class="fas fa-arrow-right ms-1"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Item Details -->
                <div class="card d-none" id="step2">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-boxes me-2"></i>
                            Bước 2: Dòng vật tư
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Barcode Scanner -->
                        <div class="barcode-scanner mb-3">
                            <h6><i class="fas fa-barcode me-2"></i>Quét mã vạch vật tư</h6>
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="text" class="form-control barcode-input" placeholder="Nhập hoặc quét mã vạch vật tư..." autofocus>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-success w-100" onclick="addItemRow()">
                                        <i class="fas fa-plus me-1"></i>Thêm vật tư
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Items Table -->
                        <div class="table-responsive">
                            <table class="table table-bordered" id="itemsTable">
                                <thead class="table-primary">
                                    <tr>
                                        <th>STT</th>
                                        <th>Mã vật tư</th>
                                        <th>Tên vật tư</th>
                                        <th>Đơn vị</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                        <th>Vị trí lưu</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td>VT001</td>
                                        <td>Vít M4x20</td>
                                        <td>Cái</td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm quantity-input" value="100" min="1" onchange="calculateTotal(this)">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm price-input" value="2500" min="0" onchange="calculateTotal(this)">
                                        </td>
                                        <td class="amount-input">250,000</td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" value="A-01-02" placeholder="Vị trí lưu">
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>VT015</td>
                                        <td>PCB Mainboard</td>
                                        <td>Bộ</td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm quantity-input" value="20" min="1" onchange="calculateTotal(this)">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm price-input" value="150000" min="0" onchange="calculateTotal(this)">
                                        </td>
                                        <td class="amount-input">3,000,000</td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" value="B-02-01" placeholder="Vị trí lưu">
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="table-info">
                                        <td colspan="6" class="text-end fw-bold">Tổng cộng:</td>
                                        <td class="fw-bold" id="totalAmount">3,250,000</td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="prevStep()">
                                <i class="fas fa-arrow-left me-1"></i>Quay lại
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Tiếp theo <i class="fas fa-arrow-right ms-1"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Confirmation -->
                <div class="card d-none" id="step3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            Bước 3: Xác nhận thông tin
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Thông tin phiếu</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Số phiếu:</strong></td>
                                        <td id="confirmGrnNumber">GRN-2024-001</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Ngày nhập:</strong></td>
                                        <td id="confirmGrnDate">15/01/2024</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Kho nhập:</strong></td>
                                        <td id="confirmGrnWarehouse">Kho nguyên liệu chính</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Nhà cung cấp:</strong></td>
                                        <td id="confirmGrnSupplier">Công ty TNHH ABC</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>Tổng kết</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Số dòng vật tư:</strong></td>
                                        <td id="confirmItemCount">2</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Tổng số lượng:</strong></td>
                                        <td id="confirmTotalQty">120</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Tổng giá trị:</strong></td>
                                        <td id="confirmTotalAmount">3,250,000 VNĐ</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Vui lòng kiểm tra lại thông tin trước khi lưu phiếu nhập kho.
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="prevStep()">
                                <i class="fas fa-arrow-left me-1"></i>Quay lại
                            </button>
                            <button type="button" class="btn btn-success" onclick="saveGrn()">
                                <i class="fas fa-save me-1"></i>Lưu phiếu nhập
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        let currentStep = 1;
        const totalSteps = 3;

        $(document).ready(function() {
            // Set current date
            $('#grnDate').val(new Date().toISOString().split('T')[0]);

            // Barcode scanner
            $('.barcode-input').on('keypress', function(e) {
                if (e.which === 13) {
                    var barcode = $(this).val();
                    if (barcode) {
                        showAlert('Đang tìm kiếm vật tư: ' + barcode, 'info');
                        setTimeout(function() {
                            showAlert('Tìm thấy vật tư: Vít M4x20', 'success');
                        }, 1000);
                    }
                    $(this).val('').focus();
                }
            });
        });

        function nextStep() {
            if (currentStep < totalSteps) {
                $('#step' + currentStep).addClass('d-none');
                currentStep++;
                $('#step' + currentStep).removeClass('d-none');
                updateProgress();
                updateStepBadges();
                
                if (currentStep === 3) {
                    updateConfirmationData();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                $('#step' + currentStep).addClass('d-none');
                currentStep--;
                $('#step' + currentStep).removeClass('d-none');
                updateProgress();
                updateStepBadges();
            }
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            $('#wizardProgress').css('width', progress + '%');
        }

        function updateStepBadges() {
            $('.badge.rounded-circle').removeClass('bg-primary bg-secondary').addClass('bg-secondary');
            $('.badge.rounded-circle').eq(currentStep - 1).removeClass('bg-secondary').addClass('bg-primary');
        }

        function calculateTotal(input) {
            const row = $(input).closest('tr');
            const quantity = parseFloat(row.find('.quantity-input').val()) || 0;
            const price = parseFloat(row.find('.price-input').val()) || 0;
            const amount = quantity * price;
            
            row.find('.amount-input').text(amount.toLocaleString('vi-VN'));
            updateTotalAmount();
        }

        function updateTotalAmount() {
            let total = 0;
            $('.amount-input').each(function() {
                const amount = parseFloat($(this).text().replace(/[^\d]/g, '')) || 0;
                total += amount;
            });
            $('#totalAmount').text(total.toLocaleString('vi-VN'));
        }

        function addItemRow() {
            const tbody = $('#itemsTable tbody');
            const newRow = `
                <tr>
                    <td>${tbody.find('tr').length + 1}</td>
                    <td>VT023</td>
                    <td>Thép tấm 2mm</td>
                    <td>Kg</td>
                    <td>
                        <input type="number" class="form-control form-control-sm quantity-input" value="50" min="1" onchange="calculateTotal(this)">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm price-input" value="25000" min="0" onchange="calculateTotal(this)">
                    </td>
                    <td class="amount-input">1,250,000</td>
                    <td>
                        <input type="text" class="form-control form-control-sm" placeholder="Vị trí lưu">
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(newRow);
            updateRowNumbers();
        }

        function removeRow(button) {
            $(button).closest('tr').remove();
            updateRowNumbers();
            updateTotalAmount();
        }

        function updateRowNumbers() {
            $('#itemsTable tbody tr').each(function(index) {
                $(this).find('td:first').text(index + 1);
            });
        }

        function updateConfirmationData() {
            $('#confirmGrnNumber').text($('#grnNumber').val());
            $('#confirmGrnDate').text($('#grnDate').val());
            $('#confirmGrnWarehouse').text($('#grnWarehouse option:selected').text());
            $('#confirmGrnSupplier').text($('#grnSupplier option:selected').text());
            
            const itemCount = $('#itemsTable tbody tr').length;
            $('#confirmItemCount').text(itemCount);
            
            let totalQty = 0;
            $('.quantity-input').each(function() {
                totalQty += parseFloat($(this).val()) || 0;
            });
            $('#confirmTotalQty').text(totalQty);
            
            $('#confirmTotalAmount').text($('#totalAmount').text() + ' VNĐ');
        }

        function saveGrn() {
            showLoading();
            setTimeout(function() {
                hideLoading();
                showAlert('Đã lưu phiếu nhập kho thành công!', 'success');
                setTimeout(function() {
                    window.location.href = 'dashboard.html';
                }, 2000);
            }, 1500);
        }
    </script>
</body>
</html>
